<?xml version='1.0'?>
<!--
  Copyright (C) 2019  Rhys Mainwaring

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<sdf version='1.6'>
<model name='land_yacht'>
    <pose>0 0 0.075 0 0 0</pose>
    <static>false</static>

    <plugin name="main_sail_liftdrag" filename="libSailPlugin.so">
        <a0>0.0</a0>
        <cla>6.2832</cla>
        <alpha_stall>0.1592</alpha_stall>
        <cla_stall>-0.7083</cla_stall>
        <cda>0.63662</cda>
        <area>0.4858</area>
        <fluid_density>1.2</fluid_density>
        <forward>1 0 0</forward>
        <upward>0 1 0</upward>
        <cp>-0.15 0.0 0.5</cp>
        <link_name>main_sail_link</link_name>
        <radial_symmetry>true</radial_symmetry>
        <topic>lift_drag</topic>
    </plugin>

    <plugin name="ardupilot_plugin" filename="libArduPilotPlugin.so">
        <!-- MAVLink / port settings -->
        <fdm_addr>127.0.0.1</fdm_addr>
        <fdm_port_in>9002</fdm_port_in>
        <fdm_port_out>9003</fdm_port_out>
        <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>

        <!-- Coordinate frames required for APM

            Change model and gazebo from XYZ to XY-Z coordinates
        
            Math constants:
            PI   = 3.141592
            PI_2 = 1.570796
            PI_4 = 0.785398
        -->
        <modelXYZToAirplaneXForwardZDown>0 0 0 3.141593 0 0</modelXYZToAirplaneXForwardZDown>
        <gazeboXYZToNED>0 0 0 3.141593 0 0</gazeboXYZToNED>

        <!-- Sensors -->
        <imuName>base_link::imu_sensor</imuName>

        <!-- Control / channels -->

        <!-- SERVO1_FUNCTION 26 (GroundSteering)
            SERVO1_MIN 1000
            SERVO1_MAX 2000

            Input command in [0, 1]
            Target steering wheel (rudder) position in [-PI/4, PI/4]
            Note the sign on the multiplier is negative (wheel must turn
            in the opposite direction to a rudder)
        -->
        <control channel="0">
            <jointName>steering_joint</jointName>
            <useForce>1</useForce>
            <multiplier>-1.570796</multiplier>
            <offset>-0.5</offset>
            <type>POSITION</type>
            <p_gain>10</p_gain>
            <i_gain>0.01</i_gain>
            <d_gain>0</d_gain>
            <i_max>100</i_max>
            <i_min>-100</i_min>
            <cmd_max>1000</cmd_max>
            <cmd_min>-1000</cmd_min>
        </control>

        <!-- SERVO4_FUNCTION 89 (MainSail)
            SERVO4_MIN 1000
            SERVO4_MAX 2000

            Input command in [0, 1]
            Desired sail angle in [0, 80] deg

            If the sails are allowed to sheet out too far 
            the boat will not gybe.
        -->
        <!-- Direct drive of main sail -->
        <control channel="3">
            <jointName>main_sail_joint</jointName>
            <useForce>1</useForce>
            <multiplier>1.39626</multiplier>
            <offset>0</offset>
            <type>POSITION_LIMIT</type>
            <p_gain>40</p_gain>
            <i_gain>0.1</i_gain>
            <d_gain>0</d_gain>
            <i_max>100</i_max>
            <i_min>-100</i_min>
            <cmd_max>1000</cmd_max>
            <cmd_min>-1000</cmd_min>
        </control>

    </plugin>

    <!-- Base -->
    <link name="base_link">
        <!-- Main beam -->
        <visual name="base">
        <geometry>
            <mesh>
                <uri>model://land_yacht/meshes/land_yacht_base.stl</uri>
            </mesh>
        </geometry>
        <material>
            <script>
            <name>Gazebo/Gray</name>
            </script>
        </material>
        </visual>

        <visual name="steering_visual">
            <pose>0.89 0 0 0 0 0</pose>
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/steering_assembly_v3.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                <name>Gazebo/Gray</name>
                </script>
            </material>
        </visual>

        <visual name="motor_visual">
            <pose>0.57 0 0.22 0 0 0</pose>
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/motor_mount_v2.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                <name>Gazebo/Gray</name>
                </script>
            </material>
        </visual>

        <!-- Main beam -->
        <collision name="main_beam_collision">
            <pose>0.4 0 0.025 0 0 0</pose>
            <geometry>
                <box>
                <size>1.0 0.020 0.020</size>
                </box>
            </geometry>
        </collision>

        <!-- Cross beam -->
        <collision name="cross_beam_collision">
            <pose>0 0 0 0 0 0</pose>
            <geometry>
                <box>
                <size>0.020 1.0 0.020</size>
                </box>
            </geometry>
        </collision>

        <visual name="imu_visual">
            <pose>0.05 0 0.06 0 0 0</pose>
            <geometry>
                <box>
                    <size>0.06 0.04 0.01</size>
                </box>
            </geometry>
            <material>
                <script>
                    <name>Gazebo/Green</name>
                </script>
            </material>
        </visual>

      <!-- <sensor name='camera' type='camera'>
        <always_on>1</always_on>
        <update_rate>30</update_rate>
        <camera name='camera'>
          <horizontal_fov>1.047</horizontal_fov>
          <image>
            <width>800</width>
            <height>800</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.02</near>
            <far>300</far>
          </clip>
        </camera> -->
        <!-- <plugin name='camera_plugin' filename='libgazebo_ros_camera.so'>
          <alwaysOn>1</alwaysOn>
          <updateRate>0.0</updateRate>
          <cameraName>camera</cameraName>
          <imageTopicName>rgb/image_raw</imageTopicName>
          <cameraInfoTopicName>rgb/camera_info</cameraInfoTopicName>
          <frameName>camera_link_optical</frameName>
          <hackBaseline>0.07</hackBaseline>
          <distortionK1>0.0</distortionK1>
          <distortionK2>0.0</distortionK2>
          <distortionK3>0.0</distortionK3>
          <distortionT1>0.0</distortionT1>
          <distortionT2>0.0</distortionT2>
        </plugin> -->
        <!-- <pose frame=''>0.5 0 0.3 0 -0 0</pose>
      </sensor> -->

        <sensor name='imu_sensor' type='imu'>
            <pose>0.05 0 0.06 3.141593 0 0</pose>
            <always_on>1</always_on>
            <update_rate>1000</update_rate>
            <visualize>1</visualize>
            <topic>sensors/imu</topic>
            <imu>
                <topic>sensors/imu</topic>
                <angular_velocity/>
                <linear_acceleration/>
            </imu>
            <!-- <plugin name='imu_plugin' filename='libgazebo_ros_imu_sensor.so'>
                <gaussianNoise>0.0</gaussianNoise>
                <always_on>1</always_on>
                <updateRateHZ>50</updateRateHZ>
                <topicName>sensors/imu</topicName>
                <bodyName>imu_link</bodyName>
                <frameName>imu_link</frameName>
                <xyzOffset>0 0 0</xyzOffset>
                <rpyOffset>0 0 0</rpyOffset>
            </plugin> -->
            <!-- <pose frame=''>0 0 0.01 0 -0 0</pose> -->
        </sensor>

        <!-- <sensor name="anemometer_sensor" type="anemometer">
        <pose>0 0 0 0 0 0</pose>
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <topic>anemometer</topic>
        </sensor>
        <visual name="anemometer_visual">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
        <cylinder>
        <radius>0.025</radius>
        <length>0.025</length>
        </cylinder>
        </geometry>
        <material>
        <script>
        <name>Gazebo/Red</name>
        </script>
        </material>
        </visual> -->

        <!-- Approximate LY base inertial with a solid cuboid:

            m  = 3.544 kg
            Lx = 0.25 m
            Ly = 0.16 m
            Lz = 0.06 m

            as most of the mass is located at the 
            intersection of the two beams.
          -->
        <inertial>
        <pose>0.15 0 0.04 0 0 0</pose>
        <mass>3.544</mass>
        <inertia>
            <ixx>0.008623733</ixx>
            <ixy>0</ixy>
            <iyy>0.019521533</iyy>
            <iyz>0</iyz>
            <izz>0.026018867</izz>
        </inertia>
        </inertial>
    </link>

    <!-- Right wheel -->
    <link name="right_wheel_link">
        <pose>0 -0.512 0 1.570796327 0 0</pose>
        <visual name="right_wheel_visual">
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/sand_wheel.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                    <name>Gazebo/Gray</name>
                </script>
            </material>
        </visual>
        <collision name="right_wheel_collision">
            <geometry>
                <cylinder>
                    <radius>0.0750</radius>
                    <length>0.0235</length>
                </cylinder>
            </geometry>
        </collision>
        <inertial>
            <mass>0.112</mass>
            <inertia>
                <ixx>0.000162654</ixx>
                <ixy>0</ixy>
                <iyy>0.000162654</iyy>
                <iyz>0</iyz>
                <izz>0.000315</izz>
            </inertia>
        </inertial>
    </link>

    <joint type="revolute" name="right_wheel_joint">
        <pose>0 0 0 0 0 0</pose>
        <child>right_wheel_link</child>
        <parent>base_link</parent>
        <axis>
            <xyz>0 0 1</xyz>
            <dynamics>
                <damping>0.001</damping>
                <!-- <friction>0.01</friction> -->
            </dynamics>
        </axis>
    </joint> 

    <!-- Left wheel -->
    <link name="left_wheel_link">
        <pose>0 0.512 0 1.570796327 0 0</pose>
        <visual name="left_wheel_visual">
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/sand_wheel.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                    <name>Gazebo/Gray</name>
                </script>
            </material>
        </visual>
        <collision name="left_wheel_collision">
            <geometry>
                <cylinder>
                    <radius>0.0750</radius>
                    <length>0.0235</length>
                </cylinder>
            </geometry>
        </collision>
        <inertial>
            <mass>0.112</mass>
            <inertia>
                <ixx>0.000162654</ixx>
                <ixy>0</ixy>
                <iyy>0.000162654</iyy>
                <iyz>0</iyz>
                <izz>0.000315</izz>
            </inertia>
        </inertial>
    </link>

    <joint type="revolute" name="left_wheel_joint">
        <pose>0 0 0 0 0 0</pose>
        <child>left_wheel_link</child>
        <parent>base_link</parent>
        <axis>
            <xyz>0 0 1</xyz>
            <dynamics>
                <damping>0.001</damping>
                <!-- <friction>0.01</friction> -->
            </dynamics>
        </axis>
    </joint> 

    <!-- Steering unit -->
    <link name="steering_link">
      <pose>1.05 0 0 0 0 0</pose>

      <visual name="steering_visual">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
            <mesh>
                <uri>model://land_yacht/meshes/land_yacht_forks_v4.stl</uri>
            </mesh>
        </geometry>
        <material>
          <script>
            <name>Gazebo/Gray</name>
          </script>
        </material>
      </visual>
      <collision name="steering_collision">
        <pose>-0.05 0 0.01 0 0 0</pose>
        <geometry>
          <box>
            <size>0.14 0.05 0.05</size>
          </box>
        </geometry>
      </collision>

      <inertial>
        <pose>-0.05 0 0.01 0 0 0</pose>
        <mass>0.073</mass>
        <inertia>
          <ixx>3.04167E-05</ixx>
          <ixy>0</ixy>
          <iyy>0.000134442</iyy>
          <iyz>0</iyz>
          <izz>0.000134442</izz>
        </inertia>
      </inertial>
    </link>

    <joint type="revolute" name="steering_joint">
        <pose>-0.114 0 0.045 0 0 0</pose>
        <child>steering_link</child>
        <parent>base_link</parent>
        <axis>
            <xyz>-1 0 0.700207538</xyz>
            <limit>
                <lower>-0.8</lower>
                <upper>0.8</upper>
            </limit>
        </axis>
    </joint> 

    <!-- Front wheel -->
    <link name="front_wheel_link">
        <pose>1.05 0 0 1.570796327 0 0</pose>
        <visual name="front_wheel_visual">
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/sand_wheel.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                    <name>Gazebo/Gray</name>
                </script>
            </material>
        </visual>
        <collision name="front_wheel_collision">
            <geometry>
                <cylinder>
                    <radius>0.0750</radius>
                    <length>0.0235</length>
                </cylinder>
            </geometry>
        </collision>
        <inertial>
            <mass>0.112</mass>
            <inertia>
                <ixx>0.000162654</ixx>
                <ixy>0</ixy>
                <iyy>0.000162654</iyy>
                <iyz>0</iyz>
                <izz>0.000315</izz>
            </inertia>
        </inertial>
    </link>

    <joint type="revolute" name="front_wheel_joint">
        <pose>0 0 0 0 0 0</pose>
        <child>front_wheel_link</child>
        <parent>steering_link</parent>
        <axis>
            <xyz>0 0 1</xyz>
            <dynamics>
                <damping>0.001</damping>
                <!-- <friction>0.01</friction> -->
            </dynamics>
        </axis>
    </joint>

    <!-- Main sail-->
    <link name="main_sail_link">
        <pose>0.5 0 0.04 0 -0.20943951 0</pose>
        <visual name="main_rig_visual">
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/land_yacht_rig.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                    <name>Gazebo/Gray</name>
                </script>
            </material>
        </visual>
        <visual name="main_sail_visual">
            <pose>-0.01 0 0.12 0 0.20943951 0</pose>
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/land_yacht_flat_sail.stl</uri>
                </mesh>
            </geometry>
            <material>
                <script>
                    <name>Gazebo/GreyTransparent</name>
                </script>
            </material>
        </visual>
        <collision name="main_sail_collision">
            <geometry>
                <mesh>
                    <uri>model://land_yacht/meshes/land_yacht_rig.stl</uri>
                </mesh>
            </geometry>
        </collision>

        <inertial>
            <pose>0 0 0 0 0 0</pose>
            <mass>0.5</mass>
            <inertia>
                <ixx>0.16</ixx>
                <ixy>0</ixy>
                <iyy>0.16</iyy>
                <iyz>0</iyz>
                <izz>0.16</izz>
            </inertia>
        </inertial>


    </link>

    <joint type="revolute" name="main_sail_joint">
        <child>main_sail_link</child>
        <parent>base_link</parent>
        <axis>
            <xyz>0 0 1</xyz>
            <initial_position>0</initial_position>
            <dynamics>
                <damping>0.001</damping>
                <!-- <friction>0.01</friction> -->
            </dynamics>
            <limit>
                <lower>-1.396263402</lower>
                <upper>1.396263402</upper>
            </limit>
        </axis>
        <sensor name="force_torque_sensor" type="force_torque">
            <always_on>true</always_on>
            <update_rate>30</update_rate>
            <visualize>true</visualize>
        </sensor>
    </joint>

</model>
</sdf>
